---
import '../styles/global.css';
import { ClientRouter } from 'astro:transitions';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import CookieConsent from '../components/CookieConsent.astro';
import StickyBar from '../components/StickyBar.astro';
import ExitIntentPopup from '../components/ExitIntentPopup.astro';

interface Props {
  title?: string;
  description?: string;
  lang?: string;
  structuredData?: object;
  alternatePaths?: { en?: string; de?: string; pl?: string };
  frontmatter?: any;
}

const {
  frontmatter,
  title = frontmatter?.title || 'RespireLabs',
  description = frontmatter?.description || '',
  lang = frontmatter?.lang || 'en',
  structuredData = frontmatter?.structuredData,
  alternatePaths
} = Astro.props;

const siteUrl = 'https://smartmouthtape.com';
const altPaths = alternatePaths || frontmatter?.alternatePaths;
const currentPath = Astro.url.pathname.replace(/^\/(en|de|pl)/, '');
const enPath = altPaths?.en || `/en${currentPath}`;
const dePath = altPaths?.de || `/de${currentPath}`;
const plPath = altPaths?.pl || `/pl${currentPath}`;

// Generate BreadcrumbList structured data from URL path
const pathSegments = Astro.url.pathname.split('/').filter(Boolean);
const breadcrumbItems = pathSegments.map((segment, index) => {
  let name;
  if (index === 0 && (segment === 'en' || segment === 'de' || segment === 'pl')) {
    name = segment === 'de' ? 'Startseite' : segment === 'pl' ? 'Strona glowna' : 'Home';
  } else {
    name = segment.charAt(0).toUpperCase() + segment.slice(1).replace(/-/g, ' ');
  }
  return {
    "@type": "ListItem",
    "position": index + 1,
    "name": name,
    "item": `${siteUrl}/${pathSegments.slice(0, index + 1).join('/')}`
  };
});

// Determine og:type — 'article' for blog post pages, 'website' for everything else
const isBlogPost = /^\/(en|de|pl)\/blog\/.+/.test(Astro.url.pathname);
const ogType = isBlogPost ? 'article' : 'website';

const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": breadcrumbItems
};
---

<!doctype html>
<html lang={lang} class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="/assets/logo/respire-labs-symbol_blue-symbol.png" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta name="theme-color" content="#FAFAFA" media="(prefers-color-scheme: light)" />
    <meta name="theme-color" content="#0a0f1e" media="(prefers-color-scheme: dark)" />

    <link rel="alternate" hreflang="en" href={`${siteUrl}${enPath}`} />
    <link rel="alternate" hreflang="de" href={`${siteUrl}${dePath}`} />
    <link rel="alternate" hreflang="pl" href={`${siteUrl}${plPath}`} />
    <link rel="alternate" hreflang="x-default" href={`${siteUrl}${enPath}`} />
    <link rel="canonical" href={`${siteUrl}${Astro.url.pathname}`} />

    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content={ogType} />
    <meta property="og:url" content={`${siteUrl}${Astro.url.pathname}`} />
    <meta property="og:image" content={`${siteUrl}/assets/logo/respire-labs-logo_primary-logo.png`} />
    <meta property="og:locale" content={lang === 'de' ? 'de_DE' : lang === 'pl' ? 'pl_PL' : 'en_US'} />
    <meta property="og:site_name" content="RespireLabs" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />

    {structuredData && (
      <script type="application/ld+json" is:inline set:html={JSON.stringify(structuredData)} />
    )}
    <!-- BreadcrumbList Schema -->
    <script type="application/ld+json" is:inline set:html={JSON.stringify(breadcrumbSchema)} />
    <!-- Global Organization Schema -->
    <script type="application/ld+json" is:inline set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "RespireLabs",
      "url": siteUrl,
      "logo": `${siteUrl}/assets/logo/respire-labs-logo_primary-logo.png`,
      "sameAs": [
        "https://youtube.com/respirelabs",
        "https://linkedin.com/company/respirelabs",
        "https://x.com/respirelabs"
      ],
      "contactPoint": [{
        "@type": "ContactPoint",
        "contactType": "customer support",
        "email": "support@respirelabs.com"
      }]
    })} />
    <!-- Global WebSite Schema -->
    <script type="application/ld+json" is:inline set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "RespireLabs",
      "url": siteUrl,
      "inLanguage": ["en", "de", "pl"]
    })} />
    <!-- Prevent flash of wrong theme (FOUC) — default to light -->
    <script is:inline>
      (function() {
        if (localStorage.getItem('theme') === 'dark') {
          document.documentElement.classList.add('dark');
        }
      })();
    </script>
    <ClientRouter />
  </head>
  <body class="antialiased selection:bg-brand-blue selection:text-white flex flex-col min-h-screen relative overflow-x-hidden">
    <Header lang={lang} />
    
    <main id="main-content" class="flex-grow pt-16 md:pt-20 outline-none" tabindex="-1" transition:animate="fade">
      <slot />
    </main>
    
    <Footer lang={lang} />

    <StickyBar lang={lang} />
    <ExitIntentPopup lang={lang} />
    <CookieConsent lang={lang} />

    <!-- Intersection Observer for CSS .reveal animations (fallback / legacy) -->
    <script>
      const observerOptions = {
        root: null,
        rootMargin: '0px',
        threshold: 0.1
      };

      const observer = new IntersectionObserver((entries, obs) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('active');
            obs.unobserve(entry.target);
          }
        });
      }, observerOptions);

      const initCSSAnimations = () => {
        const revealElements = document.querySelectorAll('.reveal:not(.active), .reveal-left:not(.active), .reveal-right:not(.active)');
        revealElements.forEach((el) => {
          observer.observe(el);
        });
        // Hero reveal
        setTimeout(() => {
          document.querySelectorAll('.hero-reveal').forEach(el => el.classList.add('active'));
        }, 50);
      };

      // Run CSS animations on initial load
      initCSSAnimations();

      // Re-run CSS animations after View Transition navigation
      document.addEventListener('astro:after-swap', initCSSAnimations);
    </script>

    <!-- GSAP ScrollTrigger animations (lazy-loaded to avoid blocking render) -->
    <script>
      /**
       * Lazy-load GSAP animations after the page is interactive.
       * The dynamic import keeps GSAP out of the critical rendering path.
       * On Astro view transitions, cleanup old ScrollTriggers before re-init.
       */
      let gsapInitialized = false;

      async function initGSAPAnimations() {
        try {
          const { initScrollAnimations, cleanupAnimations, refreshScrollTrigger } =
            await import('../lib/animations');

          // If re-initializing after a view transition, clean up first
          if (gsapInitialized) {
            cleanupAnimations();
          }

          initScrollAnimations();
          gsapInitialized = true;

          // Also handle parallax images from ParallaxImage.astro
          const parallaxImages = document.querySelectorAll<HTMLElement>('.gsap-parallax-img');
          if (parallaxImages.length > 0) {
            const { parallax } = await import('../lib/animations');
            parallaxImages.forEach((img) => {
              const speed = parseFloat(img.dataset.speed ?? '0.3');
              parallax(img, speed);
            });
          }
        } catch (err) {
          // GSAP load failed — CSS fallback animations (.reveal) still work
          console.warn('[RespireLabs] GSAP animations failed to load:', err);
        }
      }

      // Initialize GSAP after the page is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initGSAPAnimations);
      } else {
        // DOM already loaded (e.g., script at end of body)
        initGSAPAnimations();
      }

      // Re-initialize after Astro view transition swaps in new content
      document.addEventListener('astro:after-swap', initGSAPAnimations);

      // Clean up before Astro swaps out old content (prevents stale triggers)
      document.addEventListener('astro:before-swap', async () => {
        if (gsapInitialized) {
          const { cleanupAnimations } = await import('../lib/animations');
          cleanupAnimations();
        }
      });
    </script>
  </body>
</html>