---
const { lang } = Astro.props;

const navLinks = {
  en: [
    { label: 'App', href: '/en/app' },
    { label: 'Smart Tape', href: '/en/smart-mouth-tape' },
    { label: 'How it works', href: '/en/how-it-works' },
    { label: 'Compare', href: '/en/compare' },
    { label: 'Blog', href: '/en/blog' },
    { label: 'FAQ', href: '/en/faq' },
  ],
  de: [
    { label: 'App', href: '/de/app' },
    { label: 'Smart Tape', href: '/de/smart-mouth-tape' },
    { label: 'Funktion', href: '/de/so-funktionierts' },
    { label: 'Vergleich', href: '/de/vergleich' },
    { label: 'Blog', href: '/de/blog' },
    { label: 'FAQ', href: '/de/faq' },
  ],
  pl: [
    { label: 'Aplikacja', href: '/pl/aplikacja' },
    { label: 'Smart Tape', href: '/pl/inteligentna-tasma' },
    { label: 'Jak to dziala', href: '/pl/jak-to-dziala' },
    { label: 'Porownanie', href: '/pl/porownanie' },
    { label: 'Blog', href: '/pl/blog' },
    { label: 'FAQ', href: '/pl/faq' },
  ]
};

const currentLinks = navLinks[lang as keyof typeof navLinks] || navLinks.en;
const waitlistLabels: Record<string, string> = { en: 'Waitlist', de: 'Warteliste', pl: 'Lista oczekujacych' };
const waitlistHrefs: Record<string, string> = { en: '/en/waitlist', de: '/de/warteliste', pl: '/pl/lista-oczekujacych' };
const waitlistLabel = waitlistLabels[lang as string] || waitlistLabels.en;
const waitlistHref = waitlistHrefs[lang as string] || waitlistHrefs.en;

const allLangs = ['en', 'de', 'pl'] as const;
const langNames: Record<string, string> = { en: 'English', de: 'Deutsch', pl: 'Polski' };
const langFlags: Record<string, string> = { en: 'ðŸ‡¬ðŸ‡§', de: 'ðŸ‡©ðŸ‡ª', pl: 'ðŸ‡µðŸ‡±' };
const currentLang = (lang as string) || 'en';

// Canonical paths for each language (maps page key â†’ localized path)
const localizedPaths: Record<string, Record<string, string>> = {
  'app':              { en: '/en/app',              de: '/de/app',                    pl: '/pl/aplikacja' },
  'smart-mouth-tape': { en: '/en/smart-mouth-tape', de: '/de/smart-mouth-tape',       pl: '/pl/inteligentna-tasma' },
  'how-it-works':     { en: '/en/how-it-works',     de: '/de/so-funktionierts',       pl: '/pl/jak-to-dziala' },
  'science-safety':   { en: '/en/science-safety',   de: '/de/wissenschaft-sicherheit', pl: '/pl/nauka-i-bezpieczenstwo' },
  'compare':          { en: '/en/compare',           de: '/de/vergleich',              pl: '/pl/porownanie' },
  'waitlist':         { en: '/en/waitlist',          de: '/de/warteliste',             pl: '/pl/lista-oczekujacych' },
  'contact':          { en: '/en/contact',           de: '/de/kontakt',                pl: '/pl/kontakt' },
  'about':            { en: '/en/about',             de: '/de/ueber-uns',              pl: '/pl/o-nas' },
  'privacy':          { en: '/en/privacy',           de: '/de/datenschutz',            pl: '/pl/polityka-prywatnosci' },
  'terms':            { en: '/en/terms',             de: '/de/terms',                  pl: '/pl/regulamin' },
  'data-deletion':    { en: '/en/data-deletion',     de: '/de/data-deletion',          pl: '/pl/usuwanie-danych' },
  'cookies':          { en: '/en/cookies',           de: '/de/cookies',                pl: '/pl/cookies' },
  'faq':              { en: '/en/faq',               de: '/de/faq',                    pl: '/pl/faq' },
  'blog':             { en: '/en/blog',              de: '/de/blog',                   pl: '/pl/blog' },
  'pricing':          { en: '/en/pricing',           de: '/de/pricing',                pl: '/pl/cennik' },
  'press':            { en: '/en/press',             de: '/de/press',                  pl: '/pl/prasa' },
  'facts':            { en: '/en/facts',             de: '/de/facts',                  pl: '/pl/fakty' },
  'index':            { en: '/en',                   de: '/de',                        pl: '/pl' },
};

// Build reverse lookup: path â†’ { pageKey, lang }
const pathToPage: Record<string, { key: string; lang: string }> = {};
for (const [pageKey, langs] of Object.entries(localizedPaths)) {
  for (const [l, path] of Object.entries(langs)) {
    pathToPage[path] = { key: pageKey, lang: l };
  }
}
// Also map old DE English-slug paths
pathToPage['/de/how-it-works'] = { key: 'how-it-works', lang: 'de' };
pathToPage['/de/science-safety'] = { key: 'science-safety', lang: 'de' };
pathToPage['/de/compare'] = { key: 'compare', lang: 'de' };
pathToPage['/de/waitlist'] = { key: 'waitlist', lang: 'de' };
pathToPage['/de/contact'] = { key: 'contact', lang: 'de' };
pathToPage['/de/about'] = { key: 'about', lang: 'de' };

const currentPath = Astro.url.pathname.replace(/\/$/, ''); // Remove trailing slash
const pageInfo = pathToPage[currentPath];

// Build URLs for all 3 languages
const langUrls: Record<string, string> = {};
for (const l of allLangs) {
  langUrls[l] = pageInfo
    ? (localizedPaths[pageInfo.key]?.[l] || currentPath.replace(`/${lang}`, `/${l}`))
    : currentPath.replace(`/${lang}`, `/${l}`);
}
---

<!-- Skip to content link for accessibility -->
<a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-brand-blue text-white px-4 py-2 rounded-md z-[100] focus-ring">
  Skip to main content
</a>

<header class="fixed top-0 w-full z-50 transition-all duration-500 ease-in-out border-b border-transparent" id="main-header" role="banner">
  <div class="absolute inset-0 bg-white/70 backdrop-blur-xl -z-10 transition-opacity duration-500 opacity-0" id="header-bg"></div>
  <div class="max-w-[88rem] mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center h-16 md:h-20 transition-all duration-500" id="header-container">

      <!-- Logo -->
      <a href={`/${lang}`} class="flex-shrink-0 flex items-center group focus-ring rounded-lg p-1" aria-label="RespireLabs Home">
        <img class="h-7 md:h-8 w-auto transition-transform duration-500 ease-out group-hover:scale-105" src="/assets/logo/respire-labs-logo_primary-logo.png" alt="" aria-hidden="true" />
      </a>

      <!-- Desktop Nav -->
      <nav class="hidden md:flex space-x-1 items-center bg-white/40 backdrop-blur-md px-2 py-1.5 rounded-full border border-black/[0.05] shadow-sm" aria-label="Main Navigation">
        {currentLinks.map((link) => (
          <a href={link.href} class="text-brand-dark/70 hover:text-brand-dark hover:bg-black/[0.03] focus-ring px-5 py-2 rounded-full font-montserrat text-sm font-medium transition-all duration-300">
            {link.label}
          </a>
        ))}
      </nav>

      <!-- CTA & Lang Switcher -->
      <div class="hidden md:flex items-center space-x-3 lg:space-x-4">
        <!-- Language Dropdown -->
        <div class="relative" id="lang-dropdown">
          <button
            id="lang-dropdown-btn"
            class="flex items-center gap-1.5 px-3 py-1.5 rounded-full border border-black/[0.08] bg-white/60 backdrop-blur-sm hover:bg-black/[0.04] focus-ring font-montserrat text-sm font-medium text-brand-dark transition-all duration-200"
            aria-expanded="false"
            aria-haspopup="true"
            aria-label="Select language"
          >
            <span class="text-base leading-none">{langFlags[currentLang]}</span>
            <span class="text-xs font-semibold uppercase tracking-wide">{currentLang}</span>
            <svg class="w-3.5 h-3.5 text-brand-grey/70 transition-transform duration-200" id="lang-chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <div
            id="lang-dropdown-menu"
            class="absolute right-0 top-full mt-2 w-44 rounded-2xl border border-black/[0.08] bg-white/90 backdrop-blur-xl shadow-[0_8px_30px_rgba(0,0,0,0.08)] py-1.5 opacity-0 invisible translate-y-1 transition-all duration-200 z-50"
            role="menu"
            aria-label="Language options"
          >
            {allLangs.map((l) => (
              <a
                href={langUrls[l]}
                class={`flex items-center gap-3 px-4 py-2.5 font-montserrat text-sm transition-colors duration-150 ${
                  l === currentLang
                    ? 'text-brand-blue font-semibold bg-brand-blue/[0.05]'
                    : 'text-brand-dark/80 hover:bg-black/[0.03] hover:text-brand-dark'
                }`}
                role="menuitem"
                aria-current={l === currentLang ? 'true' : undefined}
              >
                <span class="text-lg leading-none">{langFlags[l]}</span>
                <span>{langNames[l]}</span>
                {l === currentLang && (
                  <svg class="w-4 h-4 ml-auto text-brand-blue" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7" />
                  </svg>
                )}
              </a>
            ))}
          </div>
        </div>
        <a href={waitlistHref} class="bg-brand-dark text-white hover:bg-black hover:scale-[1.02] hover:shadow-[0_8px_20px_rgba(0,0,0,0.12)] focus-ring font-montserrat text-sm font-semibold py-2 px-6 rounded-full transition-all duration-300 whitespace-nowrap">
          {waitlistLabel}
        </a>
      </div>

      <!-- Mobile menu button -->
      <div class="md:hidden flex items-center">
        <button id="mobile-menu-btn" class="text-brand-dark hover:text-brand-blue focus-ring p-2 rounded-full hover:bg-black/5 transition-colors" aria-expanded="false" aria-controls="mobile-menu" aria-label="Open menu">
          <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile Menu -->
  <div id="mobile-menu" class="fixed inset-0 bg-brand-white/95 backdrop-blur-xl z-40 hidden flex-col justify-center items-center h-[100dvh] w-screen transition-opacity duration-300 opacity-0 pointer-events-none" role="dialog" aria-modal="true" aria-label="Mobile Navigation">
    <button id="close-menu-btn" class="absolute top-4 right-4 p-4 text-brand-dark focus-ring rounded-full hover:bg-black/5 transition-colors" aria-label="Close menu">
        <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12" />
        </svg>
    </button>

    <nav class="flex flex-col space-y-6 text-center w-full px-6" aria-label="Mobile Navigation">
      {currentLinks.map((link) => (
        <a href={link.href} class="text-brand-dark font-oddval text-3xl sm:text-4xl transition-colors hover:text-brand-blue focus-ring py-2 rounded-xl">
          {link.label}
        </a>
      ))}
      <div class="pt-8 flex flex-col items-center space-y-6 w-full max-w-sm mx-auto">
        <a href={waitlistHref} class="bg-brand-blue text-white font-montserrat font-semibold py-4 px-10 rounded-full text-lg shadow-[0_8px_20px_rgba(32,111,247,0.3)] hover:scale-105 transition-all w-full text-center focus-ring focus-ring-dark">
          {waitlistLabel}
        </a>
        <!-- Language pills -->
        <div class="flex items-center gap-2" role="group" aria-label="Select language">
          {allLangs.map((l) => (
            <a
              href={langUrls[l]}
              class={`flex items-center gap-2 px-5 py-2.5 rounded-full font-montserrat text-sm font-medium transition-all duration-200 focus-ring ${
                l === currentLang
                  ? 'bg-brand-dark text-white shadow-sm'
                  : 'bg-black/[0.04] text-brand-dark/70 hover:bg-black/[0.08] hover:text-brand-dark'
              }`}
              aria-current={l === currentLang ? 'page' : undefined}
            >
              <span class="text-base leading-none">{langFlags[l]}</span>
              <span>{l.toUpperCase()}</span>
            </a>
          ))}
        </div>
      </div>
    </nav>
  </div>
</header>

<script>
  function initHeader() {
    // Language dropdown toggle
    const langBtn = document.getElementById('lang-dropdown-btn');
    const langMenu = document.getElementById('lang-dropdown-menu');
    const langChevron = document.getElementById('lang-chevron');

    const openLangMenu = () => {
      if (!langMenu || !langBtn || !langChevron) return;
      langMenu.classList.remove('opacity-0', 'invisible', 'translate-y-1');
      langMenu.classList.add('opacity-100', 'visible', 'translate-y-0');
      langChevron.classList.add('rotate-180');
      langBtn.setAttribute('aria-expanded', 'true');
    };

    const closeLangMenu = () => {
      if (!langMenu || !langBtn || !langChevron) return;
      langMenu.classList.add('opacity-0', 'invisible', 'translate-y-1');
      langMenu.classList.remove('opacity-100', 'visible', 'translate-y-0');
      langChevron.classList.remove('rotate-180');
      langBtn.setAttribute('aria-expanded', 'false');
    };

    if (langBtn && langMenu) {
      langBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const isOpen = langBtn.getAttribute('aria-expanded') === 'true';
        isOpen ? closeLangMenu() : openLangMenu();
      });

      document.addEventListener('click', (e) => {
        if (!(e.target as Element)?.closest('#lang-dropdown')) {
          closeLangMenu();
        }
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && langBtn.getAttribute('aria-expanded') === 'true') {
          closeLangMenu();
          langBtn.focus();
        }
      });
    }

    // Advanced Scroll Effect for Header
    const header = document.getElementById('main-header');
    const headerBg = document.getElementById('header-bg');
    const container = document.getElementById('header-container');

    window.addEventListener('scroll', () => {
      const currentScroll = window.scrollY;

      if (currentScroll > 20) {
        header?.classList.add('border-black/[0.05]');
        header?.classList.remove('border-transparent');
        headerBg?.classList.remove('opacity-0');
        headerBg?.classList.add('opacity-100');

        // Slight shrink effect on scroll (Apple style)
        if (container) {
          container.classList.remove('md:h-20');
          container.classList.add('md:h-16');
        }
      } else {
        header?.classList.remove('border-black/[0.05]');
        header?.classList.add('border-transparent');
        headerBg?.classList.add('opacity-0');
        headerBg?.classList.remove('opacity-100');

        if (container) {
          container.classList.add('md:h-20');
          container.classList.remove('md:h-16');
        }
      }
    }, { passive: true });

    // Mobile menu toggle with accessibility
    const btn = document.getElementById('mobile-menu-btn');
    const closeBtn = document.getElementById('close-menu-btn');
    const menu = document.getElementById('mobile-menu');
    const focusableElements = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';

    const openMenu = () => {
      if(!menu || !btn) return;
      menu.classList.remove('hidden');
      // Force reflow
      void menu.offsetWidth;
      menu.classList.remove('opacity-0', 'pointer-events-none');
      menu.classList.add('opacity-100', 'pointer-events-auto');
      document.body.style.overflow = 'hidden';
      btn.setAttribute('aria-expanded', 'true');

      // Focus management
      const firstFocusable = menu.querySelectorAll(focusableElements)[0] as HTMLElement;
      if(firstFocusable) firstFocusable.focus();
    };

    const closeMenu = () => {
      if(!menu || !btn) return;
      menu.classList.add('opacity-0', 'pointer-events-none');
      menu.classList.remove('opacity-100', 'pointer-events-auto');
      document.body.style.overflow = '';
      btn.setAttribute('aria-expanded', 'false');
      btn.focus();

      // Delay hiding to allow transition
      setTimeout(() => {
          menu.classList.add('hidden');
      }, 300);
    };

    if (btn && closeBtn && menu) {
      btn.addEventListener('click', openMenu);
      closeBtn.addEventListener('click', closeMenu);

      // Close on escape key
      document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && btn.getAttribute('aria-expanded') === 'true') {
              closeMenu();
          }
      });
    }
  }

  // Run on initial load
  initHeader();

  // Re-initialize header after view transition
  document.addEventListener('astro:after-swap', () => {
    initHeader();
  });
</script>